/**
 * 	jQuery Selector UI Widget 1.0 
 *
 * 	Depends: 
 *	   - jQuery 1.4.2+
 * 	Auther:
 *     - Gavin Li 2012.08.09
 *  Update:
 *     - 2012.10.11
 * 
 *  Reference resources: jquery.multiselect.js (http://www.erichynds.com/jquery/jquery-ui-multiselect-widget)
 * 	Example: 		
		<select name="example" multiple="multiple">
			<option value="option1">Option 1</option>
			<option value="option2" selected="true">Option 2</option>
			<option value="option3">Option 3</option>
		</select>
		
		$('select').filterSelector({
			multiple: false,
			click: function(){
				// todo
			}
		});
 */
(function(b){var a=0;b.extend(b.fn,{filterSelector:function(c){return this.each(function(){var d=b.data(this,"selector");if(!d){d=new b.filterSelector(c,this);b.data(this,"selector",d)}})}});b.filterSelector=function(c,d){if(arguments.length){this.init(c,d)}};b.filterSelector.prototype={eventPrefix:"",escape:/[\-\[\]{}()*+?.,\\\^$|#\s]/g,isOpen:false,checkAllFlag:false,minWidth:50,disabled:false,options:{header:true,height:175,width:"",style:"",checkAllText:"Check all / Uncheck all",noneSelectedText:"Select options",selectedText:"# selected",displaySelectedText:false,selectedList:2,multiple:true,filter:false,groupSelected:false},init:function(c,d){var e=(this.options=b.extend(true,{},this.options,c));this.element=b(d);this.selector=b("<span />").addClass("selector").addClass(e.multiple===true&&e.filter===true?"selector-filter":"").attr({title:this.element.attr("title"),style:e.style}).insertAfter(this.element),this.input=b("<input "+(e.multiple===false||e.filter===false?'readonly="true"':"")+" ></input>").addClass("selector-input").appendTo(this.selector),this.button=b('<a href="#"></a>').addClass("selector-button").appendTo(this.selector),this.menu=b("<div />").addClass("selector-menu").appendTo(document.body);if(e.header!==false){this.header=b("<div />").addClass("selector-menu-header").appendTo(this.menu),this.headerLinkContainer=b("<ul />").html(function(){var f="";if(typeof e.header==="string"){f+="<li>"+e.header+"</li>"}else{if(e.header===true&&e.multiple===true){f+='<li><a class="selector-menu-checklink" href="#"><span>'+e.checkAllText+"</span></a></li>"}}f+='<li class="li-close"><a href="#" class="selector-menu-close"><span class="icon-close"/></a></li>';return f}).appendTo(this.header)}this.checkboxContainer=b("<div />").addClass("selector-menu-list").addClass(e.multiple?"":"selector-menu-single").append("<ul />").appendTo(this.menu);this.build();this.cache();this.bindEvents()},build:function(){var d=this.element,e=this.options,c="",f=a++;d.hide();d.find("option").each(function(j){var k=b(this),o=this.parentNode,m=this.innerHTML,p=this.title,n=this.value,h="selector-"+f+"-option-"+j,q=this.disabled,g=this.selected,l=[];if(q){l.push("item-disabled")}if(g&&!e.multiple){l.push("item-active")}c+="<li>";c+='<label for="'+h+'" title="'+p+'" class="'+l.join(" ")+'">';c+='<input id="'+h+'" name="selector_'+f+'" type="'+(e.multiple?"checkbox":"radio")+'" value="'+n+'" title="'+m+'"';if(g){c+=' checked="checked"'}if(q){c+=' disabled="disabled"'}c+=" /><span>"+m+"</span></label></li>"});this.checkboxContainer.find("ul").html(c);this.labels=this.checkboxContainer.find("label");this.inputs=this.checkboxContainer.find("input");this.setSelectorWidth();this.setMenuWidth();this.button[0].defaultValue=this.update()},update:function(){var i=this.options,e=this.checkboxContainer,d=this.inputs.filter(function(){return b.css(b(this).parents("li")[0],"display")!=="none"}),c=d.filter(":checked"),f=c.length,g;b(".group-line",e).remove();if(f===0){g=i.noneSelectedText}else{if(b.isFunction(i.selectedText)){g=i.selectedText.call(this,f,d.length,c.get())}else{if(/\d/.test(i.selectedList)&&i.selectedList>0&&f<=i.selectedList){g=c.map(function(){return b(this).next().html()}).get().join(", ")}else{g=i.selectedText.replace("#",f).replace("#",d.length)}}if(i.multiple===true&&i.groupSelected===true&&f!=d.length){var h=b("input:checked",e).parents("li").detach();h.find("input").each(function(){this.checked=true});b("li:first",e).before(h).before('<li class="group-line"></li>')}}if(i.displaySelectedText===true||f===0||i.multiple===false){this.input.val(g)}return g},bindEvents:function(){var e=this,c=this.selector,d=this.input,f=this.button,g=this.options;if(g.multiple===true&&g.filter===true){d.bind({keydown:function(h){switch(h.which){case 13:h.preventDefault();break;case 38:case 40:e.checkboxContainer.find("li:first label").trigger("mouseenter.selector");break}},keyup:function(){e._filter()},focus:function(){d.toggleClass("selector-input-active",true)},blur:function(){d.removeClass("selector-input-active")}})}else{d.bind({click:function(){e.disabled||(d.toggleClass("selector-input-active",true),f.trigger("click"))},blur:function(){if(!b.trim(d.val())){d.val(g.noneSelectedText)}}})}f.bind({click:function(){if(e.isOpen){e.close()}else{if(e.getInputValue()===g.noneSelectedText){e.items.show(),e.update()}e.open()}return false}});if(g.header!==false){this.header.delegate("a","click.selector",function(h){if(b(this).hasClass("selector-menu-close")){e.close()}else{if(b(this).hasClass("selector-menu-checklink")){e.checkAll((e.checkAllFlag=!e.checkAllFlag))}}h.preventDefault();return false})}this.checkboxContainer.delegate("label","mouseenter.selector",function(){if(!b(this).is(".item-disabled, .group-line")){e.labels.removeClass("item-hover");b(this).addClass("item-hover").find("input").focus()}}).delegate("label","keydown.selector",function(h){h.preventDefault();switch(h.which){case 9:case 27:e.close();break;case 38:case 40:case 37:case 39:e._traverse(h.which,this);break;case 13:b(this).find("input")[0].click();break}}).delegate('input[type="checkbox"], input[type="radio"]',"click.selector",function(l,j){var k=b(this),m=this.value,i=j||this.checked,h=e.element.find("option");if(this.disabled||j?0:e._trigger("click",l,{value:m,text:this.title,checked:i})===false){l.preventDefault();return}k.focus();h.each(function(){if(this.value===m){this.selected=i}else{if(!g.multiple){this.selected=false}}});if(!g.multiple){e.labels.removeClass("item-active");k.closest("label").toggleClass("item-active",i);e.close()}if(!j){e._trigger("change")}setTimeout(b.proxy(e.update,e),10)});b(document).bind("mousedown.selector",function(h){if(e.isOpen&&!b.contains(e.menu[0],h.target)&&!b.contains(e.button[0],h.target)&&h.target!==e.button[0]&&!b.contains(e.input[0],h.target)&&h.target!==e.input[0]){e.close()}})},open:function(){var c=this.selector,f=this.menu,e=this.options,d=b.trim(this.input.val());if(this.disabled||this.isOpen||this._trigger("beforeopen")===false){return}var g=c.offset();this.checkboxContainer.scrollTop(0).height(e.height).find("ul").height(e.height);f.css({top:g.top+c.outerHeight()+1,left:g.left}).show();this.input.addClass("selector-input-active");this.button.addClass("selector-button-active");this.isOpen=true;this._trigger("open")},close:function(){if(this.isOpen===false||this._trigger("beforeclose")===false){return}this.menu.hide();this.input.removeClass("selector-input-active");this.button.removeClass("selector-button-active");this.isOpen=false;this._trigger("close")},checkAll:function(c){this._toggleChecked(c)},getSelectedText:function(){if(this.options.multiple===true){$checked=this.inputs.filter(":checked");return $checked.map(function(){return b(this).attr("title")}).get().join(",")}return this.inputs.filter(":checked").attr("title")},getSelectedValue:function(){if(this.options.multiple===true){$checked=this.inputs.filter(":checked");return $checked.map(function(){return b(this).val()}).get().join(",")}return this.inputs.filter(":checked").val()},setSelectedOptions:function(c){if(c===undefined){return}var d=this,c=""+c;d._toggleChecked(0,1),d.labels.removeClass("item-hover"),b.each(c.split(","),function(e,f){d.inputs.filter(':[value="'+f+'"]').trigger("click",1)})},disableSelector:function(c){this.close(),this.selector.toggleClass("selector-disabled",c===true),this.disabled=(c===true)},setSelectorWidth:function(){var c=this.options.width;if(/\d/.test(c)&&c>=this.minWidth){this.input.width(c)}},setMenuWidth:function(){var c=this.menu,d=this.input.outerWidth()-parseInt(c.css("padding-left"),10)-parseInt(c.css("padding-right"),10)-parseInt(c.css("border-right-width"),10)-parseInt(c.css("border-left-width"),10);c.width(d||this.input.outerWidth())},cache:function(){this.items=this.checkboxContainer.find("li:not(.group-line)");this.cache=this.element.children().map(function(){var c=b(this);return c.map(function(){return this.innerHTML.toLowerCase()}).get()}).get()},getInputValue:function(){return b.trim(this.input.val())},_filter:function(i){var g=this.getInputValue(),f=this.items,c=this.inputs,d=this.cache;if(!g){f.show()}else{f.hide();var h=new RegExp(g.toLowerCase().replace(this.escape,"\\$&"),"gi");this._trigger("filter",i,b.map(d,function(e,j){if(e.search(h)!==-1){f.eq(j).show();return c.get(j)}return null}))}if(!this.isOpen){if(!g&&c.filter(":checked").length>0){this.update()}this.open()}},_toggleChecked:function(c,f){var e=this,g=this.inputs.filter(function(){return !this.disabled&&b.css(b(this).parents("li")[0],"display")!=="none"});g.each(this._toggleState("checked",c));g.eq(0).focus();this.update();var d=g.map(function(){return this.value}).get();this.element.find("option").each(function(){if(b.inArray(this.value,d)>-1){e._toggleState("selected",c).call(this)}});if(g.length&&!f){this._trigger("change")}},_toggleState:function(d,c){return function(){this[d]=c}},_traverse:function(g,h){var e=b(h),d=g===38||g===37,c=e.parent()[d?"prevAll":"nextAll"]("li:not(.selector-disabled)")[d?"last":"first"]();if(!c.length){var f=this.menu.find("ul").last();this.menu.find("label")[d?"last":"first"]().trigger("mouseover");f.scrollTop(d?f.height():0)}else{c.find("label").trigger("mouseover")}},_trigger:function(c,d,e){var h,g,f=this.options[c];e=e||{};d=b.Event(d);d.type=(c===this.eventPrefix?c:this.eventPrefix+c).toLowerCase();d.target=this.element[0];g=d.originalEvent;if(g){for(h in g){if(!(h in d)){d[h]=g[h]}}}this.element.trigger(d,e);return !(b.isFunction(f)&&f.call(this.element[0],d,e)===false||d.isDefaultPrevented())}};b.extend(b.fn,{getSelectedText:function(){return this.data("selector")?this.data("selector").getSelectedText():""},getSelectedValue:function(){return this.data("selector")?this.data("selector").getSelectedValue():""},setSelectedOptions:function(c){return this.data("selector")&&this.data("selector").setSelectedOptions(c),this},disableSelector:function(c){return this.data("selector")&&this.data("selector").disableSelector(c),this},refreshSelector:function(){return this.data("selector")&&this.data("selector").build(),this}})})(jQuery);
